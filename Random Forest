import pandas as pd
from sklearn.model_selection import train_test_split,GridSearchCV
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report,accuracy_score,f1_score, roc_curve,auc,roc_auc_score

df=pd.read_csv('F:\\Secondpaper\\Random Forest\\Excercise_2.csv')

X=df.drop('FLOOD',axis=1)
y=df['FLOOD']

X_train,X_test,y_train,y_test=train_test_split(X, y,test_size=0.2,random_state=42)

RF=RandomForestClassifier(n_estimators=100,random_state=42)
RF.fit(X_train,y_train)
y_pred=RF.predict(X_test)
y_pred_proba=RF.predict_proba(X_test)[:,1]
f1 = f1_score(y_test, y_pred)
print("优化前模型 F1 分数:", f1)

print("\n模型评估:")
print("准确率:",accuracy_score(y_test, y_pred))
print("分类报告:\n",classification_report(y_test, y_pred))

fpr,tpr,thresholds=roc_curve(y_test,y_pred_proba)
roc_auc=auc(fpr,tpr)

print(f"\nAUC值:{roc_auc:.4f}")

features=X.columns
importances=pd.DataFrame({'feature':features,'importance':RF.feature_importances_})
importances=importances.sort_values('importance',ascending=False)

print("\n特征重要性排序:")
print(importances)

importances['weight']=importances['importance']/importances['importance'].sum()
print("\n归一化后的权重:")
print(importances[['feature','weight']])

param_grid = {
    'n_estimators':[100,200,300],
    'max_depth':[None,10,20,30],
    'min_samples_split':[2,5,10]
}

grid_search=GridSearchCV(estimator=RF,param_grid=param_grid,cv=5,n_jobs=-1)
grid_search.fit(X_train,y_train)

print("\n最佳参数:",grid_search.best_params_)

best_rf=grid_search.best_estimator_
best_rf.fit(X_train, y_train)
y_pred_best=best_rf.predict(X_test)
y_pred_proba_best=best_rf.predict_proba(X_test)[:,1]
f1_best = f1_score(y_test, y_pred_best)
print("优化后模型 F1 分数:", f1_best)

fpr_best, tpr_best, _ = roc_curve(y_test, y_pred_proba_best)
roc_auc_best = auc(fpr_best, tpr_best)

print(f"\n优化后AUC值: {roc_auc_best:.4f}")
print("优化后模型准确率:", accuracy_score(y_test, y_pred_best))
