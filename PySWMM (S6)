import numpy as np
import matplotlib.pyplot as plt
from pyswmm import Simulation, Nodes, Subcatchments, LidGroups, LidUnit
from pymoo.algorithms.moo.nsga2 import NSGA2
from pymoo.core.problem import ElementwiseProblem
from pymoo.optimize import minimize
from pymoo.visualization.scatter import Scatter

class MyProblem(ElementwiseProblem):
    def __init__(self):
        super().__init__(n_var=57,n_obj=3,n_ieq_constr=1,xl=0.0,xu=[13528.3,28179.5,17978.8,8447.3,15712.0,6838.2,7772.7,6868.6,3782.9,4549.5,4225.9,3590.6,8795.3,17439.1,2408.6,18871.6,3986.7,2018.0,8322.0,2398.0,4169.3,6058.1,3099.8,2449.6,2352.2,8614.7,6833.3,18167.1,9349.7,4558.5,6450.9,12808.4,18429.9,9375.0,13747.8,6301.3,12048.5,10880.6,32185.0,136032.7,10470.8,9814.4,4941.0,11243.5,2838.5,16913.2,9729.9,10889.5,3467.9,7191.7,18444.6,14716.7,10082.7,2035.8,10568.8,2372.8,3018.5])

    def _evaluate(self, x, out, *args, **kwargs):
        with Simulation(r'E:\PycharmProjects\pythonProject\Study\nsga\S6.inp') as sim:
            LidGroups(sim)['S1'][0].unit_area=x[0]
            LidGroups(sim)['S3'][0].unit_area=x[1]
            LidGroups(sim)['S4'][0].unit_area=x[2]
            LidGroups(sim)['S12'][0].unit_area=x[3]
            LidGroups(sim)['S16'][0].unit_area=x[4]
            LidGroups(sim)['S23'][0].unit_area=x[5]
            LidGroups(sim)['S28'][0].unit_area=x[6]
            LidGroups(sim)['S34'][0].unit_area=x[7]
            LidGroups(sim)['S35'][0].unit_area=x[8]
            LidGroups(sim)['S36'][0].unit_area=x[9]
            LidGroups(sim)['S37'][0].unit_area=x[10]
            LidGroups(sim)['S40'][0].unit_area=x[11]
            LidGroups(sim)['S45'][0].unit_area=x[12]
            LidGroups(sim)['S46'][0].unit_area=x[13]
            LidGroups(sim)['S47'][0].unit_area=x[14]
            LidGroups(sim)['S48'][0].unit_area=x[15]
            LidGroups(sim)['S49'][0].unit_area=x[16]
            LidGroups(sim)['S50'][0].unit_area=x[17]
            LidGroups(sim)['S51'][0].unit_area=x[18]
            LidGroups(sim)['S52'][0].unit_area=x[19]
            LidGroups(sim)['S53'][0].unit_area=x[20]
            LidGroups(sim)['S54'][0].unit_area=x[21]
            LidGroups(sim)['S55'][0].unit_area=x[22]
            LidGroups(sim)['S57'][0].unit_area=x[23]
            LidGroups(sim)['S58'][0].unit_area=x[24]
            LidGroups(sim)['S65'][0].unit_area=x[25]
            LidGroups(sim)['S67'][0].unit_area=x[26]
            LidGroups(sim)['S68'][0].unit_area=x[27]
            LidGroups(sim)['S71'][0].unit_area=x[28]
            LidGroups(sim)['S73'][0].unit_area=x[29]
            LidGroups(sim)['S74'][0].unit_area=x[30]
            LidGroups(sim)['S91'][0].unit_area=x[31]
            LidGroups(sim)['S95'][0].unit_area=x[32]
            LidGroups(sim)['S98'][0].unit_area=x[33]
            LidGroups(sim)['S99'][0].unit_area=x[34]
            LidGroups(sim)['S101'][0].unit_area=x[35]
            LidGroups(sim)['S102'][0].unit_area=x[36]
            LidGroups(sim)['S112'][0].unit_area=x[37]
            LidGroups(sim)['S113'][0].unit_area=x[38]
            LidGroups(sim)['S114'][0].unit_area=x[39]
            LidGroups(sim)['S118'][0].unit_area=x[40]
            LidGroups(sim)['S124'][0].unit_area=x[41]
            LidGroups(sim)['S125'][0].unit_area=x[42]
            LidGroups(sim)['S128'][0].unit_area=x[43]
            LidGroups(sim)['S142'][0].unit_area=x[44]
            LidGroups(sim)['S157'][0].unit_area=x[45]
            LidGroups(sim)['S159'][0].unit_area=x[46]
            LidGroups(sim)['S160'][0].unit_area=x[47]
            LidGroups(sim)['S163'][0].unit_area=x[48]
            LidGroups(sim)['S164'][0].unit_area=x[49]
            LidGroups(sim)['S167'][0].unit_area=x[50]
            LidGroups(sim)['S171'][0].unit_area=x[51]
            LidGroups(sim)['S174'][0].unit_area=x[52]
            LidGroups(sim)['S175'][0].unit_area=x[53]
            LidGroups(sim)['S177'][0].unit_area=x[54]
            LidGroups(sim)['S178'][0].unit_area=x[55]
            LidGroups(sim)['S183'][0].unit_area=x[56]

            for step in sim:
                pass

            lid_area=np.array(np.zeros(57))
            lid_area[0] = LidGroups(sim)['S1'][0].unit_area
            lid_area[1] = LidGroups(sim)['S3'][0].unit_area
            lid_area[2] = LidGroups(sim)['S4'][0].unit_area
            lid_area[3] = LidGroups(sim)['S12'][0].unit_area
            lid_area[4] = LidGroups(sim)['S16'][0].unit_area
            lid_area[5] = LidGroups(sim)['S23'][0].unit_area
            lid_area[6] = LidGroups(sim)['S28'][0].unit_area
            lid_area[7] = LidGroups(sim)['S34'][0].unit_area
            lid_area[8] = LidGroups(sim)['S35'][0].unit_area
            lid_area[9] = LidGroups(sim)['S36'][0].unit_area
            lid_area[10] = LidGroups(sim)['S37'][0].unit_area
            lid_area[11] = LidGroups(sim)['S40'][0].unit_area
            lid_area[12] = LidGroups(sim)['S45'][0].unit_area
            lid_area[13] = LidGroups(sim)['S46'][0].unit_area
            lid_area[14] = LidGroups(sim)['S47'][0].unit_area
            lid_area[15] = LidGroups(sim)['S48'][0].unit_area
            lid_area[16] = LidGroups(sim)['S49'][0].unit_area
            lid_area[17] = LidGroups(sim)['S50'][0].unit_area
            lid_area[18] = LidGroups(sim)['S51'][0].unit_area
            lid_area[19] = LidGroups(sim)['S52'][0].unit_area
            lid_area[20] = LidGroups(sim)['S53'][0].unit_area
            lid_area[21] = LidGroups(sim)['S54'][0].unit_area
            lid_area[22] = LidGroups(sim)['S55'][0].unit_area
            lid_area[23] = LidGroups(sim)['S57'][0].unit_area
            lid_area[24] = LidGroups(sim)['S58'][0].unit_area
            lid_area[25] = LidGroups(sim)['S65'][0].unit_area
            lid_area[26] = LidGroups(sim)['S67'][0].unit_area
            lid_area[27] = LidGroups(sim)['S68'][0].unit_area
            lid_area[28] = LidGroups(sim)['S71'][0].unit_area
            lid_area[29] = LidGroups(sim)['S73'][0].unit_area
            lid_area[30] = LidGroups(sim)['S74'][0].unit_area
            lid_area[31] = LidGroups(sim)['S91'][0].unit_area
            lid_area[32] = LidGroups(sim)['S95'][0].unit_area
            lid_area[33] = LidGroups(sim)['S98'][0].unit_area
            lid_area[34] = LidGroups(sim)['S99'][0].unit_area
            lid_area[35] = LidGroups(sim)['S101'][0].unit_area
            lid_area[36] = LidGroups(sim)['S102'][0].unit_area
            lid_area[37] = LidGroups(sim)['S112'][0].unit_area
            lid_area[38] = LidGroups(sim)['S113'][0].unit_area
            lid_area[39] = LidGroups(sim)['S114'][0].unit_area
            lid_area[40] = LidGroups(sim)['S118'][0].unit_area
            lid_area[41] = LidGroups(sim)['S124'][0].unit_area
            lid_area[42] = LidGroups(sim)['S125'][0].unit_area
            lid_area[43] = LidGroups(sim)['S128'][0].unit_area
            lid_area[44] = LidGroups(sim)['S142'][0].unit_area
            lid_area[45] = LidGroups(sim)['S157'][0].unit_area
            lid_area[46] = LidGroups(sim)['S159'][0].unit_area
            lid_area[47] = LidGroups(sim)['S160'][0].unit_area
            lid_area[48] = LidGroups(sim)['S163'][0].unit_area
            lid_area[49] = LidGroups(sim)['S164'][0].unit_area
            lid_area[50] = LidGroups(sim)['S167'][0].unit_area
            lid_area[51] = LidGroups(sim)['S171'][0].unit_area
            lid_area[52] = LidGroups(sim)['S174'][0].unit_area
            lid_area[53] = LidGroups(sim)['S175'][0].unit_area
            lid_area[54] = LidGroups(sim)['S177'][0].unit_area
            lid_area[55] = LidGroups(sim)['S178'][0].unit_area
            lid_area[56] = LidGroups(sim)['S183'][0].unit_area

            greenarea=lid_area[0]+lid_area[1]+lid_area[2]+lid_area[3]+lid_area[4]+lid_area[5]+lid_area[6]+lid_area[7]\
                    +lid_area[8]+lid_area[9]+lid_area[10]+lid_area[11]+lid_area[12]+lid_area[13]+lid_area[14]+lid_area[15]\
                    +lid_area[16]+lid_area[17]+lid_area[18]+lid_area[19]+lid_area[20]+lid_area[21]+lid_area[22]+lid_area[23]\
                    +lid_area[24]+lid_area[25]+lid_area[26]+lid_area[27]+lid_area[28]+lid_area[29]+lid_area[30]+lid_area[31]+lid_area[32]+lid_area[33]\
                    +lid_area[34]+lid_area[35]+lid_area[36]+lid_area[37]+lid_area[38]+lid_area[39]+lid_area[40]+lid_area[41]\
                    +lid_area[42]+lid_area[43]+lid_area[44]+lid_area[45]+lid_area[46]+lid_area[47]+lid_area[48]+lid_area[49]\
                    +lid_area[50]+lid_area[51]+lid_area[52]+lid_area[53]+lid_area[54]+lid_area[55]+lid_area[56]

            subcatchment_runoff=np.array(np.zeros(192))
            for i in range(192):
                subcatchment_runoff[i]=Subcatchments(sim)['S'+str(i+1)].statistics['runoff']/Subcatchments(sim)['S'+str(i+1)].area/10
            R=0
            for i in range(192):
                R=R+subcatchment_runoff[i]

            node_surcharged_duration=np.array(np.zeros(192))
            for i in range(1,193):
                node_surcharged_duration[i-1]=Nodes(sim)[str(i)].statistics['surcharge_duration']
            T=np.sum(node_surcharged_duration)

            Storage_green=0.1*0.8*greenarea
            Total_storage=Storage_green

            f1=450*greenarea
            f2=R
            f3=T

            g1=Total_storage-100000

            out["F"] = [f1, f2, f3]
            out["G"] = [g1]
            sim.close()

problem=MyProblem()
algorithm=NSGA2(pop_size=100)
res=minimize(problem,algorithm,("n_gen",500),verbose=True,seed=1)
print(res.exec_time)
np.savetxt(r'F:\Results\design.txt', res.X)  
np.savetxt(r'F:\Results\objective.txt', res.F)
np.savetxt(r'F:\Results\constraint.txt', res.G)
